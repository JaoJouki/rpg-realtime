<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Painel de Controle</title>

<link rel="icon" href="/images/icon.jpg" type="image/jpeg">

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    @font-face { font-family:"Heroes Assemble 3D Italic"; src: url("/fonts/heroesassemble3dital.ttf") format("truetype"); }
    body{ font-family:"Heroes Assemble 3D Italic", Arial, sans-serif; background:#121212; color:#fff; margin:0; padding:0; }
    h1{ text-align:center; margin-top: 0; padding-top: 20px; }
    .header-group { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
    
    /* --- NAVEGAÇÃO POR ABAS (NOVO) --- */
    .tab-bar {
        display: flex;
        justify-content: center;
        background: #1f1f1f;
        border-bottom: 2px solid #000;
        position: sticky;
        top: 0;
        z-index: 500;
    }
    .tab-button {
        background: #121212;
        color: #fff;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 1.1em;
        font-weight: bold;
        transition: background 0.2s;
        border-radius: 6px 6px 0 0;
        margin: 0 5px;
        border-bottom: 3px solid transparent;
    }
    .tab-button.active {
        background: #2a2a2a;
        border-bottom: 3px solid #e74c3c;
    }
    .tab-content {
        padding: 20px;
        display: none;
    }
    .tab-content.active {
        display: block;
    }
    /* --- FIM NAVEGAÇÃO POR ABAS --- */


    /* --- ESTILOS DO MODAL (MANTIDO) --- */
    .modal-overlay {
        display: none; 
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.85);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    #addForm{
        background:#1f1f1f;
        padding: 25px;
        padding-top: 60px;
        border-radius:12px;
        width: 100%;
        max-width: 600px;
        margin: 0;
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:15px;
        position: relative;
        box-shadow:0 6px 18px rgba(0,0,0,0.4);
    }
    #addForm input {
        padding: 12px;
        border-radius:6px;
        border:0;
        background: #333;
        color: #fff;
        font-size: 1em;
    }
    #addForm button[type="submit"] {
        grid-column:span 2;
        background:#27ae60;
        color:#fff;
        cursor:pointer;
        font-weight: bold;
        padding: 12px;
        border-radius:6px;
        border:0;
        font-size: 1.1em;
    }
    .form-header {
        position: absolute;
        top: 15px;
        left: 25px;
        right: 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .form-header h2 {
        margin: 0;
        font-size: 1.5em;
    }
    .close-btn {
        background: none;
        border: none;
        color: #aaa;
        font-size: 2.5rem;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        font-weight: bold;
    }
    .close-btn:hover {
        color: #fff;
    }
    /* --- FIM ESTILOS DO MODAL --- */


    /* --- ESTILOS DE CARTÃO DE PERSONAGEM (MANTIDO) --- */
    #personagens{ display:flex; flex-wrap:wrap; gap:18px; justify-content:center; }
    .card{ position: relative; background:#1f1f1f; border-radius:10px; padding:14px; width:300px; text-align:center; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
    .portrait{ width:110px; height:110px; border-radius:50%; object-fit:cover; border:3px solid #444; margin-bottom:10px; cursor:pointer; }
    .name{ font-weight:700; margin-bottom:10px; cursor:pointer; }
    .status{ background:#333; border-radius:6px; height:34px; position:relative; margin:8px 0; }
    .status-fill{ height:100%; transition:width .3s; border-radius:6px; }
    .status-label{ position:absolute; left:0; top:0; width:100%; text-align:center; line-height:34px; font-weight:700; display:flex; gap:8px; justify-content:center; align-items:center; }
    .vida{ background:#e74c3c; }
    .sanidade{ background:#3498db; }
    .pe{ background:#f1c40f; color:#000; }
    .inline-input{ width:48px; text-align:center; background:transparent; border:0; color:inherit; font-size: 1em; }
    .btn-small{ background:rgba(255,255,255,0.08); border:0; padding:4px 8px; border-radius:4px; color:#fff; cursor:pointer; font-weight:700; font-size: 1em; }
    .btn-small:hover{ background:rgba(255,255,255,0.15); }
    /* --- FIM ESTILOS DE CARTÃO DE PERSONAGEM --- */

    /* --- ESTILOS HISTÓRICO DE DADOS (NOVO) --- */
    #historico-rolagens {
        max-width: 800px;
        margin: 0 auto;
        padding: 0 20px;
    }
    .roll-entry {
        background: #1f1f1f;
        padding: 10px 15px;
        margin-bottom: 8px;
        border-radius: 6px;
        border-left: 5px solid #e74c3c;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .roll-entry strong {
        font-size: 1.2em;
        color: #f1c40f;
    }
    .roll-entry .details {
        font-size: 0.9em;
        color: #aaa;
    }
    .roll-entry .personagem-name {
        color: #3498db;
        font-weight: bold;
    }
    /* --- FIM ESTILOS HISTÓRICO DE DADOS --- */

  </style>
</head>
<body>
    <div class="header-group">
        <h1>Painel de Controle do Mestre</h1>
        <button class="btn-small" onclick="window.location.href='/logout'">Sair</button>
    </div>

    <div class="tab-bar">
        <button class="tab-button active" data-tab="personagens-tab">Personagens</button>
        <button class="tab-button" data-tab="historico-tab">Histórico de Rolagens</button>
    </div>

    <div id="personagens-tab" class="tab-content active">
        <button class="btn-small" onclick="openModal()">+ Adicionar Personagem</button>
        <hr style="margin: 15px 0; border-color: #333;">
        <div id="personagens">
            </div>
    </div>

    <div id="historico-tab" class="tab-content">
        <h2>Histórico de Rolagens</h2>
        <div id="historico-rolagens">
            <div class="waiting-message">Nenhuma rolagem registrada ainda.</div>
        </div>
    </div>
    <div id="add-personagem-modal" class="modal-overlay">
        <form id="addForm">
            <div class="form-header">
                <h2>Adicionar Novo Personagem</h2>
                <button type="button" class="close-btn" onclick="closeModal()">&times;</button>
            </div>

            <input type="text" name="id" placeholder="ID (nome de usuário)" required>
            <input type="text" name="name" placeholder="Nome do Personagem" required>
            <input type="text" name="portrait" placeholder="URL do Retrato (opcional)">

            <input type="number" name="vidaMax" placeholder="Vida Máxima" required value="10">
            <input type="number" name="vida" placeholder="Vida Atual" required value="10">
            
            <input type="number" name="sanidadeMax" placeholder="Sanidade Máxima" required value="10">
            <input type="number" name="sanidade" placeholder="Sanidade Atual" required value="10">

            <input type="number" name="peMax" placeholder="PE Máximo" required value="10">
            <input type="number" name="pe" placeholder="PE Atual" required value="10">

            <button type="submit">Adicionar</button>
        </form>
    </div>
    <script>
    const socket = io();
    const container = document.getElementById('personagens');
    const form = document.getElementById('addForm');
    const modal = document.getElementById('add-personagem-modal');
    const historicoDiv = document.getElementById('historico-rolagens');
    let personagens = {};
    let diceHistory = [];

    // --- FUNÇÕES DE LAYOUT (NOVO) ---
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        document.getElementById(tabName).classList.add('active');
        document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
    }

    // Adiciona listener para a barra de abas
    document.querySelector('.tab-bar').addEventListener('click', (e) => {
        const button = e.target.closest('.tab-button');
        if (button) {
            openTab(button.dataset.tab);
        }
    });

    // --- FUNÇÕES DE HISTÓRICO DE DADOS (NOVO) ---
    
    function getRollDetailsHtml(roll) {
        let details = roll.rolls.map(r => 
            `<span style="color: #ccc;">${r.type}</span>: ${r.results.join(', ')}`
        ).join('; ');
        
        return `<div class="roll-entry">
            <div>
                <strong>${roll.total}</strong> (Rolagem de <span class="personagem-name">${roll.personagemName}</span>)
            </div>
            <div class="details">
                **Dados:** ${roll.expression}
            </div>
            <div class="details">
                **Detalhes:** ${details}
            </div>
            <div class="details">
                <small>${new Date(roll.timestamp).toLocaleTimeString()}</small>
            </div>
        </div>`;
    }

    function renderDiceHistory() {
        if (diceHistory.length === 0) {
            historicoDiv.innerHTML = '<div class="waiting-message">Nenhuma rolagem registrada ainda.</div>';
            return;
        }

        historicoDiv.innerHTML = diceHistory.map(getRollDetailsHtml).join('');
    }

    // --- FUNÇÕES DE MODAL/PERSONAGEM (MANTIDO) ---

    function openModal() {
      modal.style.display = 'flex';
      form.elements.id.focus();
    }

    function closeModal() {
      modal.style.display = 'none';
      form.reset();
    }

    function getCardHtml(p) {
      const vidaPercent = (p.vida / p.vidaMax) * 100;
      const sanidadePercent = (p.sanidade / p.sanidadeMax) * 100;
      const pePercent = (p.pe / p.peMax) * 100;

      return `
        <div class="card" data-id="${p.id}">
          <img class="portrait" src="${p.portrait || '/images/default.jpg'}" alt="${p.name}" data-action="copy-link">
          <div class="name" data-action="rename-char">${p.name}</div>

          <div class="status vida">
              <div class="status-fill vida" style="width: ${vidaPercent}%;"></div>
              <div class="status-label">
                  <span>Vida</span>
                  <input type="number" class="inline-input" data-action="update-stat" name="vida" value="${p.vida}"> / ${p.vidaMax}
              </div>
          </div>
          <div class="status sanidade">
              <div class="status-fill sanidade" style="width: ${sanidadePercent}%;"></div>
              <div class="status-label">
                  <span>Sanidade</span>
                  <input type="number" class="inline-input" data-action="update-stat" name="sanidade" value="${p.sanidade}"> / ${p.sanidadeMax}
              </div>
          </div>
          <div class="status pe">
              <div class="status-fill pe" style="width: ${pePercent}%;"></div>
              <div class="status-label">
                  <span>PE</span>
                  <input type="number" class="inline-input" data-action="update-stat" name="pe" value="${p.pe}"> / ${p.peMax}
              </div>
          </div>

          <div style="margin-top: 10px;">
              <button class="btn-small" data-action="remove-char">Remover</button>
              <button class="btn-small" data-action="copy-link">Link Ficha</button>
          </div>
        </div>
      `;
    }

    function render() {
      container.innerHTML = Object.values(personagens).map(getCardHtml).join('');
    }

    // --- LISTENERS DE AÇÕES (MANTIDO) ---

    container.addEventListener('click', (e) => {
      const action = e.target.dataset.action;
      const card = e.target.closest('.card');
      if (!card) return;
      const id = card.dataset.id;

      switch (action) {
        case 'remove-char': {
          if (confirm(`Tem certeza que deseja remover o personagem ${personagens[id].name}?`)) {
            socket.emit('remove', id);
          }
          break;
        }
        case 'rename-char': {
            const newId = prompt(`Novo ID para ${personagens[id].name}:`);
            if (newId && newId !== id) {
                socket.emit('rename', { oldId: id, newId });
            }
            break;
        }
        case 'copy-link': {
          const urlFicha = `${window.location.origin}/ficha?id=${id}`;
          navigator.clipboard.writeText(urlFicha).then(() => {
            alert(`Link para a ficha de ${personagens[id].name} copiado!\n${urlFicha}`);
          });
          break;
        }
      }
    });

    container.addEventListener('change', (e) => {
      const input = e.target.closest('[data-action="update-stat"]');
      if (!input) return;
      const id = input.closest('.card').dataset.id;
      const stat = input.name;
      let valor = parseInt(input.value);
      if (!isNaN(valor)) {
        if (valor < 0) {
          valor = 0;
          input.value = valor;
        }
        socket.emit('update', { id, [stat]: valor });
      }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const novoPersonagem = {};
      for (let [key, value] of formData.entries()) {
        novoPersonagem[key] = isNaN(value) || !value ? value : parseInt(value);
      }
      if (!novoPersonagem.id) return;
      socket.emit('add', novoPersonagem);
      form.reset();
      form.elements.id.focus();
      closeModal();
    });

    // --- LISTENERS DE SOCKET.IO (MODIFICADO) ---

    socket.on('init', (data) => {
      personagens = data || {};
      render();
    });

    socket.on('update', (data) => {
        if (data && data.id) {
            if (!personagens[data.id]) {
                personagens[data.id] = {};
            }
            Object.assign(personagens[data.id], data);
            render();
        }
    });
    
    // NOVO: Inicializa o histórico de dados
    socket.on('initDiceHistory', (data) => {
        diceHistory = data || [];
        renderDiceHistory();
    });

    // NOVO: Atualiza o histórico de dados em tempo real
    socket.on('rollResult', (data) => {
        // Adiciona a rolagem mais recente ao topo
        diceHistory.unshift(data);
        if (diceHistory.length > 50) { // Mantém o histórico visual limitado
            diceHistory.pop();
        }
        renderDiceHistory();
    });
  </script>
</body>
</html>