<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Painel de Controle</title>

  <link rel="icon" href="/images/icon.jpg" type="image/jpeg">

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    /* Estilos anteriores... */
    @font-face { font-family:"Adobe Hebrew"; src: url("/fonts/adobe-hebrew-regular.otf") format("opentype"); }
    body{ font-family:"Adobe Hebrew", Arial, sans-serif; background:#121212; color:#fff; margin:0; padding:20px; }
    h1{ text-align:center; }
    #addForm{ background:#1f1f1f; padding:18px; border-radius:12px; max-width:700px; margin:0 auto 18px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    #addForm input, #addForm button{ padding:8px; border-radius:6px; border:0; background: #333; color: #fff;}
    #addForm button{ grid-column:span 2; background:#27ae60; color:#fff; cursor:pointer; font-weight: bold; }
    #personagens{ display:flex; flex-wrap:wrap; gap:18px; justify-content:center; }
    .card{ position: relative; background:#1f1f1f; border-radius:10px; padding:14px; width:300px; text-align:center; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
    .portrait{ width:110px; height:110px; border-radius:50%; object-fit:cover; border:3px solid #444; margin-bottom:10px; cursor:pointer; }
    .name{ font-weight:700; margin-bottom:10px; cursor:pointer; }
    .status{ background:#333; border-radius:6px; height:34px; position:relative; margin:8px 0; }
    .status-fill{ height:100%; transition:width .3s; border-radius:6px; }
    .status-label{ position:absolute; left:0; top:0; width:100%; text-align:center; line-height:34px; font-weight:700; display:flex; gap:8px; justify-content:center; align-items:center; }
    .vida{ background:#e74c3c; } .sanidade{ background:#3498db; } .pe{ background:#f1c40f; color:#000; }
    .inline-input{ width:48px; text-align:center; background:transparent; border:0; color:inherit; font-size: 1em; }
    .btn-small{ background:rgba(255,255,255,0.08); border:0; padding:4px 8px; border-radius:4px; cursor:pointer; color:#fff; }
    .btn-remove{ background:#c0392b; color:#fff; border:0; padding:8px 12px; border-radius:6px; cursor:pointer; margin-top:8px; }
    .btn-vis { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 16px; padding: 0 5px; opacity: 0.8; }
    .btn-vis.is-hidden { opacity: 0.3; }

    /* Estilo para os bot√µes de a√ß√£o no canto do card */
    .card-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 5px;
    }
    .btn-card-action {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 18px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      line-height: 30px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Painel de Status</h1>
  <form id="addForm">
      <input name="id" type="text" placeholder="Nome (ID)" required>
      <input name="imagem" type="text" placeholder="URL da imagem" >
      <input name="vida" type="number" placeholder="Vida">
      <input name="vidaMax" type="number" placeholder="Vida M√°xima">
      <input name="sanidade" type="number"  placeholder="Sanidade">
      <input name="sanidadeMax" type="number"  placeholder="Sanidade M√°xima">
      <input name="pe" type="number"  placeholder="PE">
      <input name="peMax" type="number"  placeholder="PE M√°ximo">
      <button type="submit">Adicionar Personagem</button>
  </form>

  <div id="personagens"></div>

  <script>
    const socket = io();
    let personagens = {};
    const form = document.getElementById('addForm');
    const container = document.getElementById('personagens');

    function render() {
      container.innerHTML = '';
      for (const id in personagens) {
        const p = personagens[id];
        const vidaPct = p.vidaMax > 0 ? (p.vida / p.vidaMax) * 100 : 0;
        const sanPct = p.sanidadeMax > 0 ? (p.sanidade / p.sanidadeMax) * 100 : 0;
        const pePct = p.peMax > 0 ? (p.pe / p.peMax) * 100 : 0;

        const cardHTML = `
          <div class="card" data-id="${id}">
            <div class="card-actions">
              <button class="btn-card-action" data-action="copy-link" title="Copiar link da ficha do jogador">üîó</button>
              <button class="btn-card-action" data-action="open-portrait" title="Abrir overlay para stream">üë§</button>
            </div>
            
            <img src="${p.imagem || '/images/portrait.png'}" class="portrait" data-action="edit-image">
            <div class="name" data-action="edit-name">${id}</div>

            <div class="status">
              <div class="status-fill vida" style="width:${vidaPct}%"></div>
              <div class="status-label">
                <button class="btn-vis ${p.vidaVisivel === false ? 'is-hidden' : ''}" data-action="toggle-visibility" data-stat="vida">üëÅÔ∏è</button>
                <button class="btn-small" data-action="change-stat" data-stat="vida" data-delta="-1">-</button>
                Vida: <input class="inline-input" type="number" data-action="update-stat" name="vida" value="${p.vida}"> /
                <input class="inline-input" type="number" data-action="update-stat" name="vidaMax" value="${p.vidaMax}">
                <button class="btn-small" data-action="change-stat" data-stat="vida" data-delta="1">+</button>
              </div>
            </div>
            <div class="status">
              <div class="status-fill sanidade" style="width:${sanPct}%"></div>
              <div class="status-label">
                <button class="btn-vis ${p.sanidadeVisivel === false ? 'is-hidden' : ''}" data-action="toggle-visibility" data-stat="sanidade">üëÅÔ∏è</button>
                <button class="btn-small" data-action="change-stat" data-stat="sanidade" data-delta="-1">-</button>
                San: <input class="inline-input" type="number" data-action="update-stat" name="sanidade" value="${p.sanidade}"> /
                <input class="inline-input" type="number" data-action="update-stat" name="sanidadeMax" value="${p.sanidadeMax}">
                <button class="btn-small" data-action="change-stat" data-stat="sanidade" data-delta="1">+</button>
              </div>
            </div>
            <div class="status">
              <div class="status-fill pe" style="width:${pePct}%"></div>
              <div class="status-label">
                <button class="btn-vis ${p.peVisivel === false ? 'is-hidden' : ''}" data-action="toggle-visibility" data-stat="pe">üëÅÔ∏è</button>
                <button class="btn-small" data-action="change-stat" data-stat="pe" data-delta="-1">-</button>
                PE: <input class="inline-input" type="number" data-action="update-stat" name="pe" value="${p.pe}"> /
                <input class="inline-input" type="number" data-action="update-stat" name="peMax" value="${p.peMax}">
                <button class="btn-small" data-action="change-stat" data-stat="pe" data-delta="1">+</button>
              </div>
            </div>
            <button class="btn-remove" data-action="remove">Remover</button>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', cardHTML);
      }
    }
    
    container.addEventListener('click', (e) => {
      const element = e.target.closest('[data-action]');
      if (!element) return;

      const action = element.dataset.action;
      const card = element.closest('.card');
      const id = card?.dataset.id;

      if (!id) return;

      switch (action) {
        case 'edit-image': {
          const novaUrl = prompt('Nova URL da Imagem:', personagens[id].imagem);
          if (novaUrl) socket.emit('update', { id, imagem: novaUrl.trim() });
          break;
        }
        case 'edit-name': {
          const novoNome = prompt('Novo Nome:', id);
          if (novoNome && novoNome.trim() !== id) {
            socket.emit('rename', { oldId: id, newId: novoNome.trim() });
          }
          break;
        }
        // ***** IN√çCIO DA ALTERA√á√ÉO *****
        case 'change-stat': {
          const stat = element.dataset.stat;
          const delta = parseInt(element.dataset.delta);
          const p = personagens[id];
          let novoValor = p[stat] + delta;
          const maxValor = p[`${stat}Max`];

          // Valida para n√£o passar do m√°ximo ou ser menor que 0
          if (maxValor !== undefined && novoValor > maxValor) {
            novoValor = maxValor;
          }
          if (novoValor < 0) {
            novoValor = 0;
          }

          socket.emit('update', { id, [stat]: novoValor });
          break;
        }
        // ***** FIM DA ALTERA√á√ÉO *****
        case 'remove': {
          if (confirm(`Tem certeza que deseja remover ${id}?`)) {
            socket.emit('remove', id);
          }
          break;
        }
        case 'toggle-visibility': {
          const stat = element.dataset.stat;
          const statVisivelKey = `${stat}Visivel`;
          const estadoAtual = personagens[id][statVisivelKey];
          socket.emit('update', { id, [statVisivelKey]: !estadoAtual });
          break;
        }
        case 'open-portrait': {
          const encodedId = encodeURIComponent(id);
          window.open(`/overlay.html?personagem=${encodedId}`);
          break;
        }
        case 'copy-link': {
          const encodedId = encodeURIComponent(id);
          const urlFicha = `${window.location.origin}/ficha.html?personagem=${encodedId}`;
          navigator.clipboard.writeText(urlFicha).then(() => {
            alert(`Link para a ficha de ${id} copiado!\n${urlFicha}`);
          }).catch(err => {
            console.error('Erro ao copiar link: ', err);
            alert('N√£o foi poss√≠vel copiar o link.');
          });
          break;
        }
      }
    });

    // ***** IN√çCIO DA ALTERA√á√ÉO *****
    container.addEventListener('change', (e) => {
      const input = e.target.closest('[data-action="update-stat"]');
      if (!input) return;
      const id = input.closest('.card').dataset.id;
      const stat = input.name;
      let valor = parseInt(input.value);
      
      if (!isNaN(valor)) {
        const p = personagens[id];
        // Para os status atuais (vida, san, pe), verifica o m√°ximo correspondente
        if (stat === 'vida' || stat === 'sanidade' || stat === 'pe') {
            const maxValor = p[`${stat}Max`];
            if (maxValor !== undefined && valor > maxValor) {
                valor = maxValor;
            }
        }

        // Garante que o valor n√£o seja negativo
        if (valor < 0) {
            valor = 0;
        }
        
        // Sincroniza o valor no campo de input caso ele tenha sido corrigido
        input.value = valor;

        socket.emit('update', { id, [stat]: valor });
      }
    });
    // ***** FIM DA ALTERA√á√ÉO *****

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const novoPersonagem = {};
      for (let [key, value] of formData.entries()) {
        novoPersonagem[key] = isNaN(value) || !value ? value : parseInt(value);
      }
      if (!novoPersonagem.id) return;
      socket.emit('add', novoPersonagem);
      form.reset();
      form.elements.id.focus();
    });

    socket.on('init', (data) => {
      personagens = data || {};
      render();
    });

    socket.on('update', (data) => {
      if (data && data.id && personagens[data.id]) {
        Object.assign(personagens[data.id], data);
        render();
      }
    });

    socket.on('connect', () => console.log('[CLIENT] Conectado ao servidor.'));
  </script>
</body>
</html>