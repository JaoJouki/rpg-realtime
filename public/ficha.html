<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Ficha de Personagem</title>

  <link rel="icon" href="/images/icon.jpg" type="image/jpeg">

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
   @font-face {
      font-family: "Adobe Hebrew Regular";
      src: url("/fonts/adobe-hebrew-regular.otf") format("opentype");
    }
    body{ font-family:"Adobe Hebrew Regular", Arial, sans-serif; background:#121212; color:#fff; margin:0; padding:20px; display: flex; justify-content: center; align-items: center; min-height: 90vh; }
    #personagem-container{ display:flex; flex-direction: column; align-items: center; justify-content:center; gap: 20px; }
    .card{ position: relative; background:#1f1f1f; border-radius:10px; padding:14px; width:300px; text-align:center; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
    .portrait{ width:110px; height:110px; border-radius:50%; object-fit:cover; border:3px solid #444; margin-bottom:10px; }
    .name{ font-weight:700; margin-bottom:10px; font-size: 1.2em; }
    .status{ background:#333; border-radius:6px; height:34px; position:relative; margin:8px 0; }
    .status-fill{ height:100%; transition:width .3s; border-radius:6px; }
    .status-label{ position:absolute; left:0; top:0; width:100%; text-align:center; line-height:34px; font-weight:700; display:flex; gap:8px; justify-content:center; align-items:center; }
    .vida{ background:#e74c3c; } .sanidade{ background:#3498db; } .pe{ background:#f1c40f; color:#000; }
    .inline-input{ width:48px; text-align:center; background:transparent; border:0; color:inherit; font-size: 1em; }
    .btn-small{ background:rgba(255,255,255,0.08); border:0; padding:4px 8px; border-radius:4px; cursor:pointer; color:#fff; }
    .status-hidden { opacity: 0; transition: opacity 0.3s ease-in-out; }
    .waiting-message { color: #ccc; font-size: 24px; text-align: center; }

    /* Estilos da Rolagem de Dados */
    .dice-roller { background:#2a2a2a; padding: 15px; border-radius:8px; margin-top:15px; }
    .dice-roller h3 { margin-top:0; text-align:center; }
    .dice-input-group { display:flex; flex-wrap: wrap; gap:10px; justify-content:center; margin-bottom:10px; }
    .dice-input-group input { width:100%; text-align:center; padding:8px; border-radius:6px; border:0; background: #333; color: #fff; font-size: 1em;}
    .dice-roller button { width:100%; padding:10px; background:#27ae60; color:#fff; border:0; border-radius:6px; cursor:pointer; font-weight:bold; margin-top: 5px; }
    #roll-result-display { margin-top:15px; text-align:center; font-size:1.1em; min-height: 20px; background: #2a2a2a; padding: 10px; border-radius: 6px; }
    
    /* Estilo para o grupo de botões de manter dados */
    .keep-buttons-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
    .keep-button { padding: 8px 12px; background: #333; color: #fff; border: 0; border-radius: 6px; cursor: pointer; font-weight: bold; flex-grow: 1; }
    .keep-button.active { background: #e67e22; }

    /* Estilos das Anotações */
    .notes-card { width: 300px; }
    .notes-card h3 { margin-top: 0; }
    .notes-card textarea { width: 95%; height: 150px; background: #333; color: #fff; border: 0; border-radius: 6px; padding: 8px; font-family: inherit; font-size: 0.9em; resize: vertical; }

  </style>
</head>
<body>

  <div id="personagem-container"></div>

  <script>
    const socket = io();
    let personagem = null;
    const container = document.getElementById('personagem-container');
    const params = new URLSearchParams(window.location.search);
    const personagemId = params.get('personagem');

    // Variáveis de estado para os botões de manter
    let keepHighestToggle = false;
    let keepLowestToggle = false;

    function parseDiceString(diceString) {
        const regex = /(\d+)[dD](\d+)([\+\-]\d+)?/;
        const match = diceString.replace(/\s/g, '').match(regex);
        if (!match) return null;
        return {
            numDice: parseInt(match[1], 10),
            diceType: parseInt(match[2], 10),
            bonus: match[3] ? parseInt(match[3], 10) : 0,
        };
    }

    function render() {
      if (!personagemId) {
        container.innerHTML = `<div class="waiting-message">Nenhum personagem especificado.</div>`;
        return;
      }
      if (!personagem) {
        container.innerHTML = `<div class="waiting-message">Aguardando dados para "${personagemId}"...</div>`;
        return;
      }
      
      const p = personagem;
      const vidaPct = p.vidaMax > 0 ? Math.min(100, (p.vida / p.vidaMax) * 100) : 0;
      const sanPct = p.sanidadeMax > 0 ? Math.min(100, (p.sanidade / p.sanidadeMax) * 100) : 0;
      const pePct = p.peMax > 0 ? Math.min(100, (p.pe / p.peMax) * 100) : 0;

      const cardHTML = `
        <div class="card" data-id="${personagemId}">
          <img src="${p.imagem || '/images/portrait.png'}" class="portrait">
          <div class="name">${personagemId}</div>

          <div class="status ${p.vidaVisivel === false ? 'status-hidden' : ''}">
            <div class="status-fill vida" style="width:${vidaPct}%"></div>
            <div class="status-label">
              <button class="btn-small" data-action="change-stat" data-stat="vida" data-delta="-1">-</button>
              Vida: <input class="inline-input" type="number" data-action="update-stat" name="vida" value="${p.vida}"> /
              <input class="inline-input" type="number" data-action="update-stat" name="vidaMax" value="${p.vidaMax}">
              <button class="btn-small" data-action="change-stat" data-stat="vida" data-delta="1">+</button>
            </div>
          </div>
          <div class="status ${p.sanidadeVisivel === false ? 'status-hidden' : ''}">
            <div class="status-fill sanidade" style="width:${sanPct}%"></div>
            <div class="status-label">
              <button class="btn-small" data-action="change-stat" data-stat="sanidade" data-delta="-1">-</button>
              San: <input class="inline-input" type="number" data-action="update-stat" name="sanidade" value="${p.sanidade}"> /
              <input class="inline-input" type="number" data-action="update-stat" name="sanidadeMax" value="${p.sanidadeMax}">
              <button class="btn-small" data-action="change-stat" data-stat="sanidade" data-delta="1">+</button>
            </div>
          </div>
          <div class="status ${p.peVisivel === false ? 'status-hidden' : ''}">
            <div class="status-fill pe" style="width:${pePct}%"></div>
            <div class="status-label">
              <button class="btn-small" data-action="change-stat" data-stat="pe" data-delta="-1">-</button>
              PE: <input class="inline-input" type="number" data-action="update-stat" name="pe" value="${p.pe}"> /
              <input class="inline-input" type="number" data-action="update-stat" name="peMax" value="${p.peMax}">
              <button class="btn-small" data-action="change-stat" data-stat="pe" data-delta="1">+</button>
            </div>
          </div>
          
           <div class="dice-roller">
                <h3>Rolagem de Dados</h3>
                <div class="dice-input-group">
                    <input type="text" id="dice-string" placeholder="Ex: 2d20+5">
                </div>
                <div class="keep-buttons-group">
                    <button id="keep-highest-btn" class="keep-button ${keepHighestToggle ? 'active' : ''}" data-keep="highest">Manter Maior</button>
                    <button id="keep-lowest-btn" class="keep-button ${keepLowestToggle ? 'active' : ''}" data-keep="lowest">Manter Menor</button>
                </div>
                <button id="roll-button">Rolar</button>
            </div>
        </div>
        <div class="card notes-card">
          <h3>Anotações</h3>
          <textarea id="notes-area" data-action="update-notes" placeholder="Suas anotações sobre o personagem...">${p.anotacoes || ''}</textarea>
        </div>
        <div id="roll-result-display">Aguardando rolagem...</div>
      `;
      container.innerHTML = cardHTML;

      const keepHighestBtn = document.getElementById('keep-highest-btn');
      const keepLowestBtn = document.getElementById('keep-lowest-btn');
      
      keepHighestBtn.addEventListener('click', () => {
          keepHighestToggle = !keepHighestToggle;
          keepLowestToggle = false;
          render();
      });
      
      keepLowestBtn.addEventListener('click', () => {
          keepLowestToggle = !keepLowestToggle;
          keepHighestToggle = false;
          render();
      });

      document.getElementById('roll-button').addEventListener('click', () => {
          const diceString = document.getElementById('dice-string').value;
          const parsed = parseDiceString(diceString);
          if (parsed) {
              const keepHighest = keepHighestToggle ? 1 : null;
              const keepLowest = keepLowestToggle ? 1 : null;
              
              if ((keepHighest || keepLowest) && parsed.numDice < 2) {
                   alert("Você precisa rolar 2 ou mais dados para usar 'Manter Maior' ou 'Manter Menor'.");
                   return;
              }

              socket.emit('roll', { id: personagemId, ...parsed, keepHighest, keepLowest });
          } else {
              alert("Formato de dado inválido. Use o formato 'NdN+B', por exemplo: '2d6+3'.");
          }
      });
    }
    
    container.addEventListener('click', (e) => {
      const element = e.target.closest('[data-action="change-stat"]');
      if (!element || !personagem) return;
      const stat = element.dataset.stat;
      const delta = parseInt(element.dataset.delta);
      let novoValor = personagem[stat] + delta;
      if (novoValor < 0) novoValor = 0;
      socket.emit('update', { id: personagemId, [stat]: novoValor });
    });

    container.addEventListener('change', (e) => {
      const element = e.target.closest('[data-action="update-stat"], [data-action="update-notes"]');
      if (!element || !personagem) return;
      
      const stat = element.dataset.action === 'update-notes' ? 'anotacoes' : element.name;
      const value = element.dataset.action === 'update-notes' ? element.value : parseInt(element.value);

      if (stat === 'anotacoes') {
        socket.emit('update', { id: personagemId, [stat]: value });
      } else if (!isNaN(value)) {
        let finalValue = value < 0 ? 0 : value;
        if(value < 0) element.value = 0;
        socket.emit('update', { id: personagemId, [stat]: finalValue });
      }
    });

    socket.on('init', (data) => {
      if (data && data[personagemId]) {
        personagem = data[personagemId];
        render();
      }
    });

    socket.on('update', (data) => {
      if (data && data.id === personagemId) {
        if (!personagem) personagem = {};
        Object.assign(personagem, data);
        render();
      }
    });

    function formatRollResult(data) {
        const { rolls, keptRolls, bonus, total } = data;
        let rollsCopy = [...rolls];
        const keptIndices = [];

        keptRolls.forEach(keptRoll => {
            const index = rollsCopy.indexOf(keptRoll);
            if (index > -1) {
                keptIndices.push(index);
                rollsCopy[index] = null;
            }
        });

        const formattedRolls = rolls.map((roll, index) => 
            keptIndices.includes(index) ? `${roll}` : `<s>${roll}</s>`
        ).join(', ');

        return `<b>Você</b> rolou <b>${total}</b> <i>(Dados: ${formattedRolls}; Bônus: ${bonus})</i>`;
    }

    socket.on('rollResult', (data) => {
        if (data.id === personagemId) {
            const resultDisplay = document.getElementById('roll-result-display');
            if(resultDisplay) {
                resultDisplay.innerHTML = formatRollResult(data);
            }
        }
    });

    socket.on('connect', () => {
        console.log('[FICHA] Conectado ao servidor.');
        if (personagemId) {
            document.title = `Ficha - ${personagemId}`;
        }
    });
  </script>
</body>
</html>