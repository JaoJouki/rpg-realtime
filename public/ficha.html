<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Ficha de Personagem</title>
  <link rel="icon" href="/images/icon.jpg" type="image/jpeg">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    @font-face {
      font-family: "Adobe Hebrew Regular";
      src: url("/fonts/adobe-hebrew-regular.otf") format("opentype");
    }
    body { font-family: "Adobe Hebrew Regular", Arial, sans-serif; background: #121212; color: #fff; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; }
    #sheet-container { display: flex; flex-direction: column; gap: 20px; max-width: 700px; width: 100%; }
    .card { background: #1f1f1f; border-radius: 10px; padding: 20px; box-shadow: 0 6px 18px rgba(0,0,0,0.4); }
    .card h2 { margin-top: 0; border-bottom: 2px solid #27ae60; padding-bottom: 8px; }
    .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    label { font-weight: bold; color: #ccc; }
    input[type="text"], input[type="number"], select, textarea {
      width: 95%; background: #333; color: #fff; border: 1px solid #444; border-radius: 6px; padding: 10px; font-family: inherit; font-size: 1em;
    }
    textarea { resize: vertical; min-height: 100px; }
    .status-bar { background: #333; border-radius: 6px; height: 38px; position: relative; margin: 8px 0; }
    .status-fill { height: 100%; transition: width .3s; border-radius: 6px; }
    .status-label { position: absolute; left: 0; top: 0; width: 100%; text-align: center; line-height: 38px; font-weight: 700; display: flex; gap: 8px; justify-content: center; align-items: center; }
    .vida { background: #e74c3c; } .sanidade { background: #3498db; }
    .inline-input { width: 48px; text-align: center; background: transparent; border: 0; color: inherit; font-size: 1em; padding: 0; }
    .btn-small { background: rgba(255,255,255,0.08); border: 0; padding: 4px 8px; border-radius: 4px; cursor: pointer; color: #fff; }
    .dynamic-list .list-item { display: flex; gap: 10px; margin-bottom: 10px; }
    .dynamic-list .list-item input { flex-grow: 1; }
    .btn-remove-item { background: #c0392b; color: #fff; border: 0; border-radius: 6px; cursor: pointer; padding: 0 12px; font-weight: bold; }
    .btn-add-item { background: #27ae60; color: #fff; border: 0; border-radius: 6px; cursor: pointer; padding: 10px; font-weight: bold; margin-top: 10px; }
    .waiting-message { color: #ccc; font-size: 24px; text-align: center; margin-top: 50px; }
  </style>
</head>
<body>

  <div id="sheet-container">
     </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const personagemId = params.get('personagem');
    const mesaId = params.get('mesa');
    const socket = io({ query: { mesaId } });
    let personagem = null;
    const container = document.getElementById('sheet-container');

    const ESTILOS = {
        'porradeiro': { vidaMax: 5, sanidadeMax: 3, nome: 'Porradeiro/a' },
        'genial': { vidaMax: 3, sanidadeMax: 5, nome: 'Genial' },
        'malandrao': { vidaMax: 3, sanidadeMax: 3, nome: 'Malandrão/na' }
    };

    function collectFormData() {
        const data = { id: personagemId };
        document.querySelectorAll('[data-stat]').forEach(el => {
            const stat = el.dataset.stat;
            if (el.type === 'checkbox') {
                data[stat] = el.checked;
            } else {
                data[stat] = el.value;
            }
        });

        data.especialidades = Array.from(document.querySelectorAll('.especialidade-item'))
            .map(el => el.value).filter(Boolean);
        
        data.poderes = Array.from(document.querySelectorAll('.poder-item'))
            .map(el => el.value).filter(Boolean);

        return data;
    }

    function emitUpdate() {
        const data = collectFormData();
        socket.emit('update', data);
    }
    
    function render() {
        if (!personagemId || !mesaId) {
            container.innerHTML = `<div class="waiting-message">Ficha inválida. Link incorreto.</div>`;
            return;
        }
        if (!personagem) {
            container.innerHTML = `<div class="waiting-message">Aguardando dados para "${personagemId}"...</div>`;
            return;
        }

        const p = personagem;
        const vidaPct = p.vidaMax > 0 ? Math.min(100, (p.vida / p.vidaMax) * 100) : 0;
        const sanPct = p.sanidadeMax > 0 ? Math.min(100, (p.sanidade / p.sanidadeMax) * 100) : 0;
        
        const especialidadesHTML = (p.especialidades || []).map(item => `
            <div class="list-item">
                <input type="text" class="especialidade-item" value="${item}">
                <button class="btn-remove-item" data-type="especialidade">X</button>
            </div>
        `).join('');

        const poderesHTML = (p.poderes || []).map(item => `
            <div class="list-item">
                <input type="text" class="poder-item" value="${item}">
                <button class="btn-remove-item" data-type="poder">X</button>
            </div>
        `).join('');

        const sheetHTML = `
            <div class="card">
                <h2>Identidade</h2>
                <div class="grid-2-col">
                    <div class="form-group">
                        <label>NOME</label>
                        <input type="text" data-stat="nome" value="${p.nome || ''}">
                    </div>
                    <div class="form-group">
                        <label>IDENTIDADE SECRETA</label>
                        <input type="text" data-stat="identidadeSecreta" value="${p.identidadeSecreta || ''}">
                    </div>
                    <div class="form-group">
                        <label>IDADE</label>
                        <input type="text" data-stat="idade" value="${p.idade || ''}">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Status</h2>
                <div class="status-bar">
                    <div class="status-fill vida" style="width:${vidaPct}%"></div>
                    <div class="status-label">
                        <button class="btn-small" data-action="change-stat" data-field="vida" data-delta="-1">-</button>
                        Vida: <input class="inline-input" type="number" data-stat="vida" value="${p.vida}"> /
                        <span class="max-stat">${p.vidaMax}</span>
                        <button class="btn-small" data-action="change-stat" data-field="vida" data-delta="1">+</button>
                    </div>
                </div>
                <div class="status-bar">
                    <div class="status-fill sanidade" style="width:${sanPct}%"></div>
                    <div class="status-label">
                        <button class="btn-small" data-action="change-stat" data-field="sanidade" data-delta="-1">-</button>
                        Sanidade: <input class="inline-input" type="number" data-stat="sanidade" value="${p.sanidade}"> /
                        <span class="max-stat">${p.sanidadeMax}</span>
                        <button class="btn-small" data-action="change-stat" data-field="sanidade" data-delta="1">+</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>Perfil</h2>
                <div class="form-group">
                    <label>DESCRIÇÃO FÍSICA</label>
                    <textarea data-stat="descricaoFisica">${p.descricaoFisica || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>HISTÓRIA</label>
                    <textarea data-stat="historia">${p.historia || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>ESTILO</label>
                    <select data-stat="estilo" id="estilo-select">
                        <option value="">-- Escolha um Estilo --</option>
                        <option value="porradeiro" ${p.estilo === 'porradeiro' ? 'selected' : ''}>Porradeiro/a (+1 Físico/Ataque, 5 Vida / 3 San)</option>
                        <option value="genial" ${p.estilo === 'genial' ? 'selected' : ''}>Genial (+1 Mental/Controle, 3 Vida / 5 San)</option>
                        <option value="malandrao" ${p.estilo === 'malandrao' ? 'selected' : ''}>Malandrão/na (+1 Social/Ágil, 3 Vida / 3 San)</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2>Especialidades</h2>
                <div class="dynamic-list" id="especialidades-list">${especialidadesHTML}</div>
                <button class="btn-add-item" data-type="especialidade">Adicionar Especialidade</button>
            </div>

            <div class="card">
                <h2>Poderes</h2>
                <div class="dynamic-list" id="poderes-list">${poderesHTML}</div>
                <button class="btn-add-item" data-type="poder">Adicionar Poder</button>
            </div>
        `;
        container.innerHTML = sheetHTML;
    }

    container.addEventListener('change', (e) => {
        if (e.target.matches('[data-stat]')) {
            let data = { id: personagemId };
            const stat = e.target.dataset.stat;
            
            if (stat === 'estilo') {
                const estiloKey = e.target.value;
                const estiloData = ESTILOS[estiloKey];
                if (estiloData) {
                    data.estilo = estiloKey;
                    data.vidaMax = estiloData.vidaMax;
                    data.sanidadeMax = estiloData.sanidadeMax;
                    // Garante que a vida atual não ultrapasse a nova máxima
                    if (personagem.vida > data.vidaMax) data.vida = data.vidaMax;
                    if (personagem.sanidade > data.sanidadeMax) data.sanidade = data.sanidadeMax;
                } else { // Caso "Escolha um Estilo" seja selecionado
                    data.estilo = "";
                    data.vidaMax = 1;
                    data.sanidadeMax = 1;
                }
            } else {
                data[stat] = e.target.type === 'number' ? parseInt(e.target.value, 10) : e.target.value;
            }
            socket.emit('update', data);
        }
    });
    
    container.addEventListener('blur', (e) => {
        if (e.target.matches('.especialidade-item, .poder-item')) {
            emitUpdate();
        }
    }, true);

    container.addEventListener('click', (e) => {
        if (e.target.matches('[data-action="change-stat"]')) {
            const field = e.target.dataset.field;
            const delta = parseInt(e.target.dataset.delta);
            let novoValor = personagem[field] + delta;
            if (novoValor < 0) novoValor = 0;
            if (field === 'vida' && novoValor > personagem.vidaMax) novoValor = personagem.vidaMax;
            if (field === 'sanidade' && novoValor > personagem.sanidadeMax) novoValor = personagem.sanidadeMax;
            socket.emit('update', { id: personagemId, [field]: novoValor });
        }

        if (e.target.matches('.btn-add-item')) {
            const type = e.target.dataset.type;
            const list = document.getElementById(`${type}es-list`);
            const newItem = document.createElement('div');
            newItem.className = 'list-item';
            newItem.innerHTML = `
                <input type="text" class="${type}-item" placeholder="Nova ${type}...">
                <button class="btn-remove-item" data-type="${type}">X</button>
            `;
            list.appendChild(newItem);
            newItem.querySelector('input').focus();
        }

        if (e.target.matches('.btn-remove-item')) {
            e.target.closest('.list-item').remove();
            emitUpdate();
        }
    });

    socket.on('init', (data) => {
        if (data && data[personagemId]) {
            personagem = data[personagemId];
            render();
        }
    });

    socket.on('update', (data) => {
        if (data && data.id === personagemId) {
            if (!personagem) personagem = {};
            Object.assign(personagem, data);
            render();
        }
    });
    
    socket.on('connect', () => {
        console.log('[FICHA] Conectado ao servidor.');
        if (personagemId) {
            document.title = `Ficha - ${personagemId}`;
        }
    });
  </script>
</body>
</html>