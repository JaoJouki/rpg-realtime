<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Painel de Controle</title>
  <link rel="icon" href="/images/icon.jpg" type="image/jpeg">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body{ font-family: "Adobe Hebrew Regular", Arial, sans-serif; background:#121212; color:#fff; margin:0; padding:20px; }
    h1{ text-align:center; }
    .header-nav { display: flex; justify-content: space-between; align-items: center; max-width: 900px; margin: 0 auto 20px; }
    .nav-back-button { padding: 8px 16px; background: #3498db; color: #fff; text-decoration: none; border-radius: 6px; font-weight: bold; }
    #addForm{ background:#1f1f1f; padding:18px; border-radius:12px; max-width:400px; margin:0 auto 18px; display:grid; grid-template-columns: 1fr auto; gap:10px; }
    #addForm input { padding:10px; border-radius:6px; border:0; background: #333; color: #fff; }
    #addForm button { background:#27ae60; color:#fff; cursor:pointer; font-weight: bold; padding:10px 20px; border-radius:6px; border:0; }
    #main-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    #personagens{ display:flex; flex-wrap:wrap; gap:18px; justify-content:center; flex: 3; min-width: 320px; }
    #dice-history-container { flex: 2; min-width: 300px; background: #1f1f1f; padding: 18px; border-radius: 12px; max-height: 500px; overflow-y: auto;}
    .card{ position: relative; background:#1f1f1f; border-radius:10px; padding:14px; width:300px; text-align:center; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
    .portrait{ width:110px; height:110px; border-radius:50%; object-fit:cover; border:3px solid #444; margin-bottom:10px; cursor:pointer; }
    .name{ font-weight:700; margin-bottom:5px; cursor:pointer; }
    .estilo { font-style: italic; color: #ccc; margin-bottom: 10px; min-height: 20px; }
    .status{ background:#333; border-radius:6px; height:34px; position:relative; margin:8px 0; }
    .status-fill{ height:100%; transition:width .3s; border-radius:6px; }
    .status-label{ position:absolute; left:0; top:0; width:100%; text-align:center; line-height:34px; font-weight:700; display:flex; gap:8px; justify-content:center; align-items:center; }
    .vida{ background:#e74c3c; } .sanidade{ background:#3498db; }
    .inline-input{ width:48px; text-align:center; background:transparent; border:0; color:inherit; font-size: 1em; }
    .btn-small{ background:rgba(255,255,255,0.08); border:0; padding:4px 8px; border-radius:4px; cursor:pointer; color:#fff; }
    .btn-remove{ background:#c0392b; color:#fff; border:0; padding:8px 12px; border-radius:6px; cursor:pointer; margin-top:8px; }
    .card-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
    .btn-card-action { background: rgba(255, 255, 255, 0.1); border: none; color: #fff; cursor: pointer; font-size: 18px; width: 30px; height: 30px; border-radius: 50%; line-height: 30px; text-align: center; }
  </style>
</head>
<body>
  <div class="header-nav">
      <a id="back-to-lobby-btn" href="#" class="nav-back-button">‚Üê Voltar ao Lobby</a>
      <h1>Painel de Status</h1>
  </div>
  
  <form id="addForm">
      <input name="id" type="text" placeholder="Nome do Novo Personagem" required>
      <button type="submit">Adicionar</button>
  </form>

  <div id="main-container">
    <div id="personagens"></div>
    <div id="dice-history-container">
      <h2 style="text-align: center; margin-top: 0;">Hist√≥rico de Rolagens</h2>
      <div id="dice-history"></div>
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const mesaId = params.get('mesa');
    const socket = io({ query: { mesaId } });
    let personagens = {};
    const form = document.getElementById('addForm');
    const container = document.getElementById('personagens');
    const diceHistoryContainer = document.getElementById('dice-history');

    const ESTILOS_NOME = {
        'porradeiro': 'Porradeiro/a',
        'genial': 'Genial',
        'malandrao': 'Malandr√£o/na'
    };

    if (!mesaId) {
        document.body.innerHTML = '<h1>Mesa n√£o especificada. Volte para a p√°gina inicial e selecione uma mesa.</h1>';
    } else {
        document.querySelector('h1').innerText += ` | Mesa: ${mesaId}`;
        document.getElementById('back-to-lobby-btn').href = `/mesa.html?mesa=${mesaId}`;
    }

    function render() {
      container.innerHTML = '';
      for (const id in personagens) {
        const p = personagens[id];
        const vidaPct = p.vidaMax > 0 ? Math.min(100, (p.vida / p.vidaMax) * 100) : 0;
        const sanPct = p.sanidadeMax > 0 ? Math.min(100, (p.sanidade / p.sanidadeMax) * 100) : 0;
        const estiloNome = ESTILOS_NOME[p.estilo] || 'Estilo n√£o definido';

        const cardHTML = `
          <div class="card" data-id="${id}">
            <div class="card-actions">
              <button class="btn-card-action" data-action="copy-link" title="Copiar link da ficha">üîó</button>
              <button class="btn-card-action" data-action="open-sheet" title="Abrir ficha">üìÑ</button>
              <button class="btn-card-action" data-action="open-portrait" title="Abrir overlay">üë§</button>
            </div>
            <img src="${p.imagem || '/images/portrait.png'}" class="portrait" data-action="edit-image">
            <div class="name" data-action="edit-name">${id}</div>
            <div class="estilo">${estiloNome}</div>
            <div class="status">
              <div class="status-fill vida" style="width:${vidaPct}%"></div>
              <div class="status-label">
                <button class="btn-small" data-action="change-stat" data-stat="vida" data-delta="-1">-</button>
                Vida: <input class="inline-input" type="number" data-action="update-stat" name="vida" value="${p.vida}"> / ${p.vidaMax}
                <button class="btn-small" data-action="change-stat" data-stat="vida" data-delta="1">+</button>
              </div>
            </div>
            <div class="status">
              <div class="status-fill sanidade" style="width:${sanPct}%"></div>
              <div class="status-label">
                <button class="btn-small" data-action="change-stat" data-stat="sanidade" data-delta="-1">-</button>
                San: <input class="inline-input" type="number" data-action="update-stat" name="sanidade" value="${p.sanidade}"> / ${p.sanidadeMax}
                <button class="btn-small" data-action="change-stat" data-stat="sanidade" data-delta="1">+</button>
              </div>
            </div>
            <button class="btn-remove" data-action="remove">Remover</button>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', cardHTML);
      }
    }
    
    // As fun√ß√µes de eventos (clicks, changes, submit) e socket.on permanecem majoritariamente as mesmas.
    // Apenas ajustamos o 'change-stat' para lidar com os novos m√°ximos.
    container.addEventListener('click', (e) => {
        const element = e.target.closest('[data-action]');
        if (!element) return;
        const action = element.dataset.action;
        const card = element.closest('.card');
        const id = card?.dataset.id;
        if (!id) return;

        const p = personagens[id];
        const urlFicha = `${window.location.origin}/ficha.html?mesa=${mesaId}&personagem=${encodeURIComponent(id)}`;

        switch (action) {
            case 'edit-image': {
                const novaUrl = prompt('Nova URL da Imagem:', p.imagem);
                if (novaUrl !== null) socket.emit('update', { id, imagem: novaUrl.trim() });
                break;
            }
            case 'edit-name': {
                const novoNome = prompt('Novo Nome:', id);
                if (novoNome && novoNome.trim() !== id) {
                    socket.emit('rename', { oldId: id, newId: novoNome.trim() });
                }
                break;
            }
            case 'change-stat': {
                const stat = element.dataset.stat;
                const delta = parseInt(element.dataset.delta);
                let novoValor = p[stat] + delta;
                if (novoValor < 0) novoValor = 0;
                // Garante que o valor n√£o ultrapasse o m√°ximo
                if (stat === 'vida' && novoValor > p.vidaMax) novoValor = p.vidaMax;
                if (stat === 'sanidade' && novoValor > p.sanidadeMax) novoValor = p.sanidadeMax;
                socket.emit('update', { id, [stat]: novoValor });
                break;
            }
            case 'remove': {
                if (confirm(`Tem certeza que deseja remover ${id}?`)) {
                    socket.emit('remove', id);
                }
                break;
            }
            case 'open-portrait': window.open(`/overlay.html?personagem=${encodeURIComponent(id)}`); break;
            case 'open-sheet': window.open(urlFicha, '_blank'); break;
            case 'copy-link': {
                navigator.clipboard.writeText(urlFicha).then(() => {
                    alert(`Link para a ficha de ${id} copiado!`);
                });
                break;
            }
        }
    });

    container.addEventListener('change', (e) => {
        const element = e.target.closest('[data-action="update-stat"]');
        if (!element) return;

        const id = element.closest('.card').dataset.id;
        const stat = element.name;
        const value = parseInt(element.value, 10);
        
        if (!isNaN(value)) {
            let finalValue = value < 0 ? 0 : value;
            socket.emit('update', { id, [stat]: finalValue });
        }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const id = formData.get('id');
      if (!id || !mesaId) return;
      socket.emit('add', { id: id.trim(), mesaId: mesaId });
      form.reset();
    });

    socket.on('init', (data) => {
      personagens = data || {};
      render();
    });

    socket.on('update', (data) => {
      if (data && data.id && personagens[data.id]) {
        Object.assign(personagens[data.id], data);
        render();
      }
    });
    
    // A fun√ß√£o formatRollResultForHistory e o socket.on('rollResult') permanecem as mesmas
    function formatRollResultForHistory(data) {
        const { rolls, keptRolls, bonus, total, id } = data;
        let rollsCopy = [...rolls];
        const keptIndices = [];
        keptRolls.forEach(keptRoll => {
            const index = rollsCopy.indexOf(keptRoll);
            if (index > -1) {
                keptIndices.push(index);
                rollsCopy[index] = null;
            }
        });
        const formattedRolls = rolls.map((roll, index) => 
            keptIndices.includes(index) ? `${roll}` : `<s>${roll}</s>`
        ).join(', ');
        return `<b>${id}</b> rolou <b>${total}</b> <i>(Dados: ${formattedRolls}; B√¥nus: ${bonus})</i>`;
    }

    socket.on('rollResult', (data) => {
        const newRoll = document.createElement('div');
        newRoll.innerHTML = formatRollResultForHistory(data);
        diceHistoryContainer.prepend(newRoll);
    });

    socket.on('connect', () => console.log('[CLIENT] Conectado ao servidor.'));
  </script>
</body>
</html>